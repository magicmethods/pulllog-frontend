## 概要

- 統計ページにタイルサイズ変更・ドラッグアンドドロップ並び替え・表示切替を統合したレイアウト管理機能を実装する。
- レイアウト状態は Pinia ストアで一元管理し、localStorage による即時永続化と、将来的な Laravel `user_filters` テーブルとの同期に対応できる構成とする。

## 機能要件

- 各チャートタイルのサイズを「最小・小・中・大・最大」の 5 段階（span=2〜6）から選択できること。
- タイルを SortableJS を用いて並び替えできること。並び順は表示状態に依存せず保持される。
- タイルごとに表示・非表示を切り替えられること。非表示タイルはレイアウト上から除外されるが順序とサイズ設定は保持する。
- タイル設定は初回ロード時に既存レイアウト（現行 span 設定）を初期値とし、ユーザー操作後は localStorage に保存される。
- スマートフォンとタブレットでのレスポンシブ挙動を考慮し、端末幅ごとにサイズ選択肢・グリッド幅を制御する（md 未満は span=6 固定、md 以上 lg 未満は span=3 / span=6 のみ選択可、lg 以上は span=2〜6 の 5 段階）。

## UI 仕様

- 各チャートカードのタイトル行に 3 つのアイコンボタン (DisplayControllerUI) を配置し、見出しとフレックスレイアウトで右側に並べる。
  - サイズ切替ボタン：`pi-expand` アイコンのアイコンボタン。クリックするとプルダウンメニューを表示し、`大 (large)`・`中 (medium)`・`小 (small)` を選択できる（文言のみ表示）。
  - 表示切替トグル：`pi-eye` / `pi-eye-slash` の状態遷移で `visible` を制御する。非表示時はタイル全体をフェードアウトし、DOM から除去する。
  - ドラッグ可能トグル：初期値はオフ。オンにしたタイルが 1 つでも存在する間は全タイルにドラッグハンドルクラスを付与し、SortableJS により並び替え操作を許可する。オフ時は全タイルを固定する。モバイル幅（`md` 未満）では常時オフ固定。
- コントロールアイコンには PrimeVue の `OverlayPanel` または `TieredMenu` を活用し、操作後は自動で閉じる。
- スマートフォン幅（Tailwind `md` 未満）ではサイズ切替 UI を無効化し、全タイルを `span-6` のフル幅で表示する。
- タブレット幅（`md` 以上 `lg` 未満）では選択肢を `small (span-3)` と `max (span-6)` の 2 段階に限定する。`lg` 以上では `span-2/span-3/span-4/span-5/span-6` の 5 段階を利用する。
- ドラッグ有効化中は視覚的に分かるよう、タイル外枠に枠線または背景色を追加する。
- 将来的な統計フィルター設定領域と並列に扱えるよう、設定アイコン群から開くヘルプモーダル（任意）を検討する。

## 状態管理（フロントエンド）

- `useStatsLayoutStore` を拡張し、状態型を次のように定義する。
  ```ts
  type TileSize = 'span-2' | 'span-3' | 'span-4' | 'span-5' | 'span-6'
  type StatsLayoutState = {
      version: 'v1'
      tiles: TileConfig[]
      filters: Record<string, unknown>
  }
  type TileConfig = {
      id: TileId
      size: TileSize
      visible: boolean
      locked?: boolean
  }
  ```
- `span` クラスは Vue 側で `size` から算出するユーティリティを実装し、ブレークポイント別に出し分け可能とする（`span-2`〜`span-6` を想定）。
- 既存タイル順・サイズを `DEFAULT_STATS_TILES` として定数化し、`resetToDefault()` で参照する。
- SortableJS 読み込みはダイナミックインポートを用い、初回ドラッグ有効化時にロードする。

## 永続化・同期仕様

- localStorage キー：`pulllog.statsLayout.v1`。JSON 形式で `StatsLayoutState` を保存する。
- ストア初期化フロー：
  1. localStorage を読み込み、JSON が有効なら採用。無効またはバージョン不一致時はデフォルトを適用。
  2. Laravel API (`GET /api/user-filters/stats`) を並列で呼び出し、取得成功時にストアへマージして localStorage を更新。
- ユーザー操作時：`store.$subscribe` で変更を検知し、即時で localStorage へ書き込み。API 実装後は 500ms デバウンスで `PUT /api/user-filters/stats` を送信する。
- API 未実装段階では同期キューを no-op とし、エラー時はローカル状態を維持する。
- `version` がサーバーと不一致の場合はリセットダイアログを表示し、ユーザー確認後 `resetToDefault()` を実行する。サーバー更新に失敗した場合は `toast` で「表示設定の読み込みに失敗しました」を通知する。

## バックエンド仕様

- テーブル `user_filters` を新設し、カラムは `id`, `user_id`, `context`, `layout` (JSON), `filters` (JSON), `version`, `created_at`, `updated_at` とする。
- 複合ユニーク制約：`user_id` + `context`。主要クエリ向けに同一組み合わせでインデックスを付与する。
- 利用想定コンテキスト：`stats`, `apps`, `history`, `gallery`。Laravel 側では列挙型またはバリデーションで制限する。
- API エンドポイント：
  - `GET /api/user-filters/{context}`：存在しない場合は 404 ではなくデフォルト JSON を返却しつつ `created` フラグを false で付与する案を検討。
  - `PUT /api/user-filters/{context}`：`version` 一致を前提に更新。相違がある場合は 409 を返し、レスポンスに最新 `version` と推奨アクションを含める。
- `filters` カラムには今後追加予定の統計フィルター条件を JSON で保存する。現在は空オブジェクトを許容する。

## テスト計画

- 手動確認：
  - 並び替え後のリロードで順序が維持されること。
  - サイズ変更後のチャート再描画が正しく行われること (`layoutKey` の再生成含む)。
  - 表示切替オフにしたタイルが再度オンにした際、元の位置・サイズで戻ること。
  - デバイス幅ごとのサイズ選択制限が期待通り機能すること。
  - localStorage を削除した場合にデフォルトへ戻ること。
- 自動テスト：Vitest でストアロジック（`setSize`, `setVisible`, `setOrder`, `hydrateFromStorage`, `resetToDefault`）をユニットテスト化する。

## 追加確認事項

1. ドラッグ可能トグル初期値：オフで確定。モバイルは常時オフのまま。
2. アイコン指定：サイズ切替は `pi-expand`、表示切替は表示中 `pi-eye-slash` → 非表示中 `pi-eye` に切り替える。
3. サイズ選択メニュー表記：文言のみを表示し、数値は併記しない。
4. 409 リカバリー時はトーストで「表示設定の読み込みに失敗しました」を通知し、再同期を促す。

## 詳細設定モーダル案

- `stats` ページ右上の「詳細設定」ボタンを活性化し、PrimeVue Dialog でモーダル表示する。
- モーダル内にチャート一覧（`TileId` とラベル）をチェックボックスリストで表示し、非表示にしたタイルも再表示できるようにする。モーダル内でも SortableJS を利用して並び替えが可能とし、フィールド側・モーダル側のどちらからでも順序調整できるようにする。
- リストの表示順は現行レイアウト順を参照し、ラベルは既存の i18n キー（例：`stats.chart.expenseRatio.expenseLabel`）を利用する。
- チェックボックスは `visible` と連動し、変更内容はモーダル下部の「適用する」ボタン押下時にストアへ反映→localStorage 保存→必要に応じて API 同期をトリガーする。
- 非表示状態の項目はテキストを `text-muted` で表示し、視覚的に区別する。フィールド側の非表示ボタンにはツールチップを追加し、「再表示する場合は「詳細設定」から設定してください」を表示する。
- 将来的な統計フィルター設定も同モーダルにタブまたはアコーディオンで統合できる構成とする。
- 「適用する」実行後に API 同期が失敗した場合はトーストで「設定の保存に失敗しました。設定内容を適用することができませんでした」を表示し、ストア状態と localStorage を直前の状態へロールバックする。

## 検討課題

- 現時点で追加の未決事項はなし。実装段階で新たな論点が出た場合は随時追記する。

